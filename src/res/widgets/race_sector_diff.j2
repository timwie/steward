{% extends "base_dynamic.j2" %}

{# ============================= VARIABLES ============================= #}
{% block vars %}
    {{ super() }}

    {% set nb_sectors = top1_sector_millis | length %}

    {% set max_nb_sectors = 16 %}

    {% set sector_w = 320 / (max_nb_sectors + 2) %}
    {% set sector_h = 4.5 %}
    {% set sector_x_padding = 1 %}
    {% set sector_bottom_order_h = 0.5 %}

    {% set sector_label_w = sector_w - sector_x_padding*2 %}
    {% set sector_label_h = 3 %}

    {% set sector_div_w = 0.2 %}

    {% set color_bar_w = nb_sectors * sector_w %}
    {% set color_bar_h = 1 %}

    {% set frame_w = (nb_sectors + 2) * sector_w %}
    {% set frame_h = color_bar_h + sector_h*2 + sector_label_h %}
    {% set frame_x_offset = -160 + (320 - frame_w) / 2.0 %}
    
{% endblock vars %}
{# ============================= MANIALINK ============================= #}
{% block manialink %}
{{ super() }}

<frame id="cp_diff" pos="0 33">
    <quad id="cp_diff_bg" z-index="1"
          size="18 6" halign="center"/>
    <label id="cp_diff_lbl" z-index="2"
           size="16" pos="0 -1.5" halign="center"
           textemboss="1" text_color="{{col_white}}" style="{{ font_bold_big }}"/>
</frame>

<!-- Colored bar at the top indicates whether the run is on course to become a new PB -->
<frame z-index="101">
    <quad id="color_bar" pos="0 90" size="{{color_bar_w}} {{color_bar_h}}" bgcolor="{{col_neutral}}" z-index="1" halign="center"/>
    <quad size="{{color_bar_w}} 0.2" pos="0 {{90 - color_bar_h}}" bgcolor="{{col_neutral}}" opacity="0.1" halign="center" valign="center"/>
</frame>

<frame pos="{{frame_x_offset}} {{90 - color_bar_h}}" z-index="100">
    <!-- Dividing lines -->
    {% for i in range(end=nb_sectors-1) %}
        <quad id="sector_div_{{i}}"
              size="{{sector_div_w}} {{sector_h * 2}}" pos="{{(i+2)*sector_w}} 0" halign="center" z-index="3"
              bgcolor="{{col_neutral}}" opacity="0.1"/>
    {% endfor %}

    <!-- Labels on the right -->
    <frame pos="{{frame_w - sector_w}} 0" z-index="1">
        <label id="map_name"
               pos="{{sector_x_padding}} {{sector_h * -0.5}}" valign="center"
               textcolor="{{col_white}}" textsize="2.5" textfont="{{font_text}}"/>
        <label id="map_author"
               pos="{{sector_x_padding}} {{sector_h * -1.5}}" valign="center"
               textcolor="{{col_white}}" textsize="1.5" textfont="{{font_text}}"/>
    </frame>

    <!-- Labels on the left -->
    <frame pos="{{sector_w - sector_x_padding}} 0" z-index="1">
        <label size="{{sector_label_w}} {{sector_label_h}}" pos="0 {{sector_h * -0.5}}"
               text="$sPB ± Top1" style="{{ font_bold_small }}" halign="right" valign="center"
               textcolor="{{col_white}}"/>
        <label size="{{sector_label_w}} {{sector_label_h}}" pos="0 {{sector_h * -1.5}}"
               text="$sLive ± Top1" style="{{ font_bold_small }}" halign="right" valign="center"
               textcolor="{{col_white}}"/>
    </frame>

    {% for idx in range(end=nb_sectors) %}
        <frame pos="{{sector_w*(idx+1)}} 0" z-index="1">
            <!-- Cell background colors indicate whether the live sector was better or worse than the PB sector time -->
            <quad id="pb_diff_bg_{{idx}}"
                  size="{{sector_w}} {{sector_h}}" pos="0 0" opacity="0.9"/>
            <quad id="live_diff_bg_{{idx}}"
                  size="{{sector_w}} {{sector_h}}" pos="0 -{{sector_h}}" opacity="0.8"/>

            <!-- Sector numbering "S1", "S2", etc on the bottom -->
            <label id="sector_label_{{idx}}"
                   pos="{{sector_w/2}} {{sector_h * -2 - sector_label_h * 0.5}}"
                   text="$sS{{idx+1}}" style="{{ font_bold_small }}" halign="center" valign="center"
                   textcolor="{{col_white}}"/>

            <frame pos="0 {{sector_h * -2}}">
                <quad id="sector_weight_{{idx}}"
                      size="{{sector_w}} 0"
                      valign="top" bgcolor="{{col_neutral}}" opacity="0.5"/>

                <quad id="sector_weight_border_{{idx}}"
                       size="{{sector_w}} {{sector_bottom_order_h}}" valign="top" bgcolor="{{col_neutral}}" opacity="0.9"/>
            </frame>

            <!-- The two diffs, one for PB vs Top1, one for Live vs Top1 -->
            <label id="pb_diff_text_{{idx}}"
                   size="{{sector_label_w}} {{sector_h}}" pos="{{sector_w/2}} {{sector_h * -0.5}}"
                   z-index="2" style="{{ font_bold_big }}" halign="center" valign="center"
                   textcolor="{{col_white}}"/>
            <label id="live_diff_text_{{idx}}"
                   size="{{sector_label_w}} {{sector_h}}" pos="{{sector_w/2}} {{sector_h * -1.5}}"
                   z-index="2" style="{{ font_bold_big }}" halign="center" valign="center"
                   textcolor="{{col_white}}"/>
        </frame>
    {% endfor %}
</frame>

{% endblock manialink %}
{# ============================= SCRIPT DECLARATIONS ============================= #}
{% block decl %}
{{ super() }}

#Const MAX_SECTOR_WEIGHT      3.0
#Const CP_DIFF_DISPLAY_MILLIS 2000


declare Integer   G_PbMillis;          // this player's pb time
declare Integer[] G_PbSectorMillis;    // this player's pb sector times

declare Integer   G_Top1Millis;        // top1 record time
declare Integer[] G_Top1SectorMillis;  // top1 record sector times

declare Integer   G_NbSectors;         // nb checkpoints + 1

declare Boolean   G_PbIsTop1;          // True if pb == top1

declare Integer   G_RunLastCpGameTime; // game time (millis) at time of crossing last cp


{% include "lib_time_to_text.j2" %}
{% include "lib_time_diff.j2" %}


Void SetSectorColor(Integer SectorIdx, Text HexColor) {
    {% raw %}
    declare UI_PbDiffBg           = (Page.GetFirstChild("""pb_diff_bg_{{{SectorIdx}}}""") as CMlQuad);
    declare UI_LiveDiffBg         = (Page.GetFirstChild("""live_diff_bg_{{{SectorIdx}}}""") as CMlQuad);
    declare UI_SectorWeight       = (Page.GetFirstChild("""sector_weight_{{{SectorIdx}}}""") as CMlQuad);
    declare UI_SectorWeightBorder = (Page.GetFirstChild("""sector_weight_border_{{{SectorIdx}}}""") as CMlQuad);
    {% endraw %}

    declare RgbColor = ColorLib::HexToRgb(HexColor);
    UI_PbDiffBg.BgColor           = RgbColor;
    UI_LiveDiffBg.BgColor         = RgbColor;
    UI_SectorWeight.BgColor       = RgbColor;
    UI_SectorWeightBorder.BgColor = RgbColor;
}

/** Clear the row for live diffs, reset the colors, update the PB diff. */
Void OnReset() {
    // Recalculate PB diff in case a new PB or Top1 was set.
    for(i, 0, G_NbSectors - 1)
    {
        {% raw %}
        declare UI_PbDiffText = (Page.GetFirstChild("""pb_diff_text_{{{i}}}""") as CMlLabel);
        {% endraw %}

        if (G_PbIsTop1) {
            UI_PbDiffText.Value = "";
        } else {
            UI_PbDiffText.Value = "$s" ^ Diff(G_Top1SectorMillis[i], G_PbSectorMillis[i]);
        }
    }

    // Clear live diffs.
    for(i, 0, G_NbSectors - 1)
    {
        {% raw %}
        declare UI_LiveDiffText = (Page.GetFirstChild("""live_diff_text_{{{i}}}""") as CMlLabel);
        {% endraw %}

        SetSectorColor(i, "{{col_neutral}}");
        UI_LiveDiffText.Value = "";
    }

    // Reset the top bar color.
    declare UI_ColorBar = (Page.GetFirstChild("color_bar") as CMlQuad);
    UI_ColorBar.BgColor = ColorLib::HexToRgb("{{col_neutral}}");
}

Void OnNewTop1() {
    // set new sector weights

    declare Real[] SectorWeights;
    declare Integer MinSectorMillis = 0;

    for(i, 0, G_NbSectors - 1) {
        if (i == 0 || G_Top1SectorMillis[i] < MinSectorMillis) {
            MinSectorMillis = G_Top1SectorMillis[i];
        }
    }

    for(i, 0, G_NbSectors - 1) {
        declare Millis = G_Top1SectorMillis[i] * 1.0;
        if (i == 0) {
             // first sector is elongated by slow start; add some offset
            Millis = MathLib::Max(0.0, Millis - 2000.0);
        }
        declare Weight = MathLib::Min(MAX_SECTOR_WEIGHT, Millis / MinSectorMillis);
        SectorWeights.add(Weight);
    }

    for(i, 0, G_NbSectors - 1) {
        {% raw %}
        declare UI_SectorLabel = (Page.GetFirstChild("""sector_label_{{{i}}}""") as CMlLabel);
        declare UI_SectorWeight = (Page.GetFirstChild("""sector_weight_{{{i}}}""") as CMlQuad);
        declare UI_SectorWeightBorder = (Page.GetFirstChild("""sector_weight_border_{{{i}}}""") as CMlQuad);
        declare UI_SectorDiv = (Page.GetFirstChild("""sector_div_{{{i}}}""") as CMlQuad);
        {% endraw %}

        declare WeightedHeight = SectorWeights[i]*{{sector_label_h}};

        UI_SectorLabel.TextSizeReal = 0.5 * SectorWeights[i];
        UI_SectorLabel.RelativePosition_V3.Y = {{sector_h * -2}} - WeightedHeight/2;

        UI_SectorWeight.Size.Y = WeightedHeight;
        UI_SectorWeightBorder.RelativePosition_V3.Y = -WeightedHeight;

        if (i < G_NbSectors - 1) { // one less dividers than sectors
            UI_SectorDiv.Size.Y = {{sector_h * 2}} + WeightedHeight + {{sector_bottom_order_h}};
        }
    }
}

/** Clear live sector data, and reset the UI. */
Void Reset(CTmRaceClientEvent Event) {
    declare Integer[] P_RunSectorMillis for Event.Player;
    declare Integer   P_RunLastCpMillis for Event.Player;
    
    P_RunSectorMillis.clear();
    P_RunLastCpMillis = 0;
    
    if (Event.Player == InputPlayer) {
        OnReset();
    }
}

/**
 * Update sector data for this player.
 * Previous data will be cleared if this is the first sector.
 *
 * If this is the input player, add the visual sector diff, and update colors.
 */
Void OnCheckpoint(CTmRaceClientEvent Event) {
    declare Integer[] P_RunSectorMillis for Event.Player;
    declare Integer   P_RunLastCpMillis for Event.Player;

    G_RunLastCpGameTime = GameTime;

    declare SectorIdx = Event.CheckpointInRace;
    if (SectorIdx == 0) {
        Reset(Event);
    } else if (SectorIdx > P_RunSectorMillis.count) {
        // If this script is added during a player's run, we might have missed some
        // sector data already. Ignore this run to prevent inconsistencies.
        return;
    }

    declare SectorMillis_Live = Event.RaceTime - P_RunLastCpMillis;
    declare SectorMillis_Pb   = G_PbSectorMillis[SectorIdx];
    declare SectorMillis_Top1 = G_Top1SectorMillis[SectorIdx];

    P_RunLastCpMillis = Event.RaceTime;
    P_RunSectorMillis.add(SectorMillis_Live);

    if (Event.Player != InputPlayer) {
        return;
    }

    declare TotalMillis_Live = Event.RaceTime;
    declare TotalMillis_Pb   = 0;

    for(i, 0, SectorIdx) {
        TotalMillis_Pb += G_PbSectorMillis  [i];
    }

    {% raw %}
    declare UI_ColorBar      = (Page.GetFirstChild("color_bar") as CMlQuad);
    declare UI_LiveDiffText  = (Page.GetFirstChild("""live_diff_text_{{{SectorIdx}}}""") as CMlLabel);
    declare UI_Diff       = (Page.GetFirstChild("cp_diff") as CMlFrame);
    declare UI_DiffLbl       = (Page.GetFirstChild("cp_diff_lbl") as CMlLabel);
    declare UI_DiffBg        = (Page.GetFirstChild("cp_diff_bg") as CMlQuad);
    {% endraw %}

    if (SectorMillis_Live >= SectorMillis_Pb) {
        SetSectorColor(SectorIdx, "{{col_fail}}");
    } else {
        SetSectorColor(SectorIdx, "{{col_success}}");
    }

    if (TotalMillis_Live >= TotalMillis_Pb) {
        UI_DiffBg.BgColor = ColorLib::HexToRgb("{{col_fail}}");
        UI_ColorBar.BgColor = ColorLib::HexToRgb("{{col_fail}}");
    } else {
        UI_ColorBar.BgColor = ColorLib::HexToRgb("{{col_success}}");
        UI_DiffBg.BgColor = ColorLib::HexToRgb("{{col_success}}");
    }

    UI_LiveDiffText.Value = "$s" ^ Diff(SectorMillis_Top1, SectorMillis_Live);

    UI_Diff.Visible = !Event.IsEndRace;
    if (!Event.IsEndRace) {
        UI_DiffLbl.Value = Diff(TotalMillis_Pb, TotalMillis_Live);
    }
}


Void OnFinish(CTmRaceClientEvent Event) {
    declare Integer[] P_RunSectorMillis for Event.Player;

    // Update PB if this player's run was better
    if (Event.Player == InputPlayer && Event.RaceTime < G_PbMillis) {
        G_PbMillis = Event.RaceTime;
        G_PbSectorMillis = P_RunSectorMillis;
    }

    // Update Top1 record if any player's run was better
    if (Event.RaceTime < G_Top1Millis) {
        G_PbIsTop1 = Event.Player == InputPlayer;
        G_Top1Millis = Event.RaceTime;
        G_Top1SectorMillis = P_RunSectorMillis;
        OnNewTop1();
    }
}

/**
 * Update the live sector data for any player,
 * and update PB & Top1 record whenever a better time was set.
 */
Void OnCheckpointOrFinish(CTmRaceClientEvent Event) {
    OnCheckpoint(Event);

    if (Event.IsEndRace) {
        OnFinish(Event);
    }
}

{% endblock decl %}
{# ============================= SCRIPT MAIN ============================= #}
{% block main %}

G_PbMillis         = {{ pb_millis }};
G_PbSectorMillis   = {{ pb_sector_millis }};
G_Top1Millis       = {{ top1_millis }};
G_Top1SectorMillis = {{ top1_sector_millis }};
G_NbSectors        = {{ nb_sectors }};

G_PbIsTop1 = True;
for(i, 0, G_NbSectors - 1) {
    assert(G_PbSectorMillis[i] >= G_Top1SectorMillis[i]);
    if (G_PbSectorMillis[i] != G_Top1SectorMillis[i]) {
        G_PbIsTop1 = False;
        break;
    }
}

declare UI_MapName = (Page.GetFirstChild("map_name") as CMlLabel);
declare UI_MapAuthor = (Page.GetFirstChild("map_author") as CMlLabel);

UI_MapName.Value = "$s" ^ Map.MapName;
UI_MapAuthor.Value = "$sby " ^ Map.AuthorLogin;

OnNewTop1();
OnReset();

{% endblock main %}
{# ============================= SCRIPT EVENTS ============================= #}
{% block race_events %}

switch (Event.Type) {
    case CTmRaceClientEvent::EType::WayPoint: {
        OnCheckpointOrFinish(Event);
    }
}

{% endblock race_events %}
{# ============================= LOOP ============================= #}
{% block loop %}

if (GameTime >= G_RunLastCpGameTime + CP_DIFF_DISPLAY_MILLIS) {
    declare UI_Diff = (Page.GetFirstChild("cp_diff") as CMlFrame);
    UI_Diff.Visible = False;
}

{% endblock loop %}
